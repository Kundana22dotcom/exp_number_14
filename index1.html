<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Task Timer — Single Page App</title>
  <style>
    :root{
      --bg:#f5f7fa; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --accent:#2563eb;
      --accent-2:#10b981; --danger:#ef4444; --ring:rgba(37,99,235,.25);
      --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:linear-gradient(135deg,#eef2ff,#f0fdfa 35%,#f5f7fa);
      color:var(--ink); display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .app{
      width:min(920px,100%); background:var(--card); border-radius:var(--radius);
      box-shadow:var(--shadow); overflow:hidden; border:1px solid #eef2f7;
    }
    header{
      padding:20px 22px; display:flex; gap:14px; align-items:center; justify-content:space-between;
      background:linear-gradient(90deg,#ffffff,#f8fafc);
      border-bottom:1px solid #eef2f7;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:40px; height:40px; display:grid; place-items:center; border-radius:12px;
      background:conic-gradient(from 180deg,#60a5fa,#34d399,#f59e0b,#60a5fa);
      color:white; font-weight:700; letter-spacing:.5px; text-shadow:0 1px 2px rgba(0,0,0,.25);
    }
    h1{font-size:18px; margin:0}
    .sub{font-size:12px; color:var(--muted)}
    .controls{display:flex; gap:10px; flex-wrap:wrap}
    input[type="text"], select{
      padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; outline:none;
      background:#fff; min-width:180px; font-size:14px;
    }
    input[type="text"]:focus, select:focus{box-shadow:0 0 0 4px var(--ring); border-color:#cfe0ff}
    button{
      border:0; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer;
    }
    .btn-primary{background:var(--accent); color:#fff}
    .btn-primary:disabled{opacity:.6; cursor:not-allowed}
    .btn-ghost{background:#eef2ff; color:#1e40af}
    main{padding:18px}
    .row{display:grid; grid-template-columns:1.2fr .8fr; gap:16px}
    @media (max-width:800px){ .row{grid-template-columns:1fr} }
    .card{background:#fff; border:1px solid #eef2f7; border-radius:12px; padding:14px}
    .card h2{margin:4px 0 12px; font-size:16px}
    ul#taskList{list-style:none; margin:0; padding:0; display:grid; gap:10px}
    .task{
      display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center;
      padding:12px; border:1px solid #eef2f7; border-radius:12px; background:#f9fafb;
    }
    .task-title{font-weight:600}
    .meta{font-size:12px; color:var(--muted)}
    .right{display:flex; align-items:center; gap:8px}
    .chip{padding:4px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#1e40af}
    .timer{font-variant-numeric:tabular-nums; font-weight:700; letter-spacing:.5px}
    .mini{padding:6px 10px; font-size:12px}
    .success{background:var(--accent-2); color:#fff}
    .danger{background:var(--danger); color:#fff}
    .empty{padding:18px; text-align:center; color:var(--muted); border:1px dashed #e5e7eb; border-radius:12px}
    footer{padding:10px 16px; font-size:12px; color:var(--muted); border-top:1px solid #eef2f7; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
    @media (prefers-reduced-motion:no-preference){
      .task{transition:transform .2s ease, background .2s ease}
      .task:active{transform:scale(.995)}
      button:active{transform:translateY(1px)}
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Task Timer App">
    <header>
      <div class="brand" aria-label="Brand">
        <div class="logo" aria-hidden="true">TT</div>
        <div>
          <h1>Task Timer</h1>
          <div class="sub">Focus better. Finish faster.</div>
        </div>
      </div>
      <form id="addForm" class="controls" autocomplete="off" aria-label="Add a task">
        <input id="taskInput" type="text" placeholder="Task title (e.g., Write report)" aria-label="Task title" required />
        <select id="durationSelect" aria-label="Duration (minutes)">
          <option value="25">25 min (Pomodoro)</option>
          <option value="15">15 min (Quick)</option>
          <option value="45">45 min (Deep)</option>
          <option value="60">60 min (Long)</option>
          <option value="5">5 min (Sprint)</option>
        </select>
        <button class="btn-primary" type="submit">Add Task</button>
        <button class="btn-ghost" type="button" id="clearAll">Clear All</button>
      </form>
    </header>

    <main>
      <div class="row">
        <section class="card" aria-labelledby="tasksHeading">
          <h2 id="tasksHeading">Active Tasks</h2>
          <ul id="taskList" aria-live="polite"></ul>
          <div id="emptyState" class="empty" hidden>No tasks yet. Add one above to get started.</div>
        </section>

        <aside class="card" aria-labelledby="statsHeading">
          <h2 id="statsHeading">Today’s Stats</h2>
          <div id="stats">
            <p><strong>Planned time:</strong> <span id="planned">0m</span></p>
            <p><strong>Completed tasks:</strong> <span id="doneCount">0</span></p>
            <p><strong>Total focused:</strong> <span id="focused">0m</span></p>
          </div>
        </aside>
      </div>
    </main>

    <footer>
      <div>Data stored locally in your browser. No sign-in needed.</div>
      <div>Tip: Use <kbd>Space</kbd> to start/pause selected task.</div>
    </footer>
  </div>

  <template id="taskTemplate">
    <li class="task" data-id="">
      <div>
        <div class="task-title"></div>
        <div class="meta"><span class="chip duration"></span> • <span class="timer">00:00</span></div>
      </div>
      <div class="right">
        <button class="mini" data-action="start">Start</button>
        <button class="mini" data-action="pause">Pause</button>
        <button class="mini success" data-action="done">Done</button>
        <button class="mini danger" data-action="delete" aria-label="Delete task">Delete</button>
      </div>
    </li>
  </template>

  <script>
    // ------- State & Helpers -------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const storeKey = "tt.tasks.v1";
    const statsKey = "tt.stats.v1";
    const intervals = new Map(); // id -> intervalId (runtime only)

    const load = (key, fallback) => {
      try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; }
    };
    const save = (key, value) => localStorage.setItem(key, JSON.stringify(value));

    let tasks = load(storeKey, []); // {id,title,durationSec,remainingSec,status:'new|running|paused|done',createdAt}
    let stats = load(statsKey, {focusedSec:0, doneCount:0});

    const fmt = (sec) => {
      sec = Math.max(0, Math.floor(sec));
      const h = Math.floor(sec/3600);
      const m = Math.floor((sec%3600)/60);
      const s = sec%60;
      return (h? String(h).padStart(2,'0')+':':'') + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    };
    const minutes = (sec) => Math.round(sec/60);

    // ------- DOM Re-render -------
    const listEl = $("#taskList");
    const emptyEl = $("#emptyState");
    const plannedEl = $("#planned");
    const doneEl = $("#doneCount");
    const focusedEl = $("#focused");

    function render(){
      listEl.innerHTML = "";
      if (tasks.length === 0){ emptyEl.hidden = false; } else { emptyEl.hidden = true; }
      const tpl = $("#taskTemplate");

      for (const t of tasks){
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.dataset.id = t.id;
        $(".task-title", node).textContent = t.title;
        $(".duration", node).textContent = `${minutes(t.durationSec)} min`;
        $(".timer", node).textContent = fmt(t.remainingSec);

        const startBtn = $('[data-action="start"]', node);
        const pauseBtn = $('[data-action="pause"]', node);
        const doneBtn  = $('[data-action="done"]', node);

        // Button states
        startBtn.disabled = (t.status === 'running' || t.status === 'done');
        pauseBtn.disabled = !(t.status === 'running');
        doneBtn.disabled  = (t.status === 'done');

        listEl.appendChild(node);
      }
      // Stats
      const planned = tasks.filter(t=>t.status!=='done').reduce((a,b)=>a+b.remainingSec,0);
      plannedEl.textContent = `${minutes(planned)}m`;
      doneEl.textContent = String(stats.doneCount);
      focusedEl.textContent = `${minutes(stats.focusedSec)}m`;
    }

    // ------- Timer Control -------
    function tick(id){
      const t = tasks.find(x=>x.id===id);
      if (!t) return;
      if (t.remainingSec <= 0){
        stopTimer(id);
        t.status = 'done';
        stats.doneCount++;
        notify(`✅ "${t.title}" completed`);
        persist();
        return;
      }
      t.remainingSec -= 1;
      stats.focusedSec += 1;
      persist(false); // save often, but don't re-render every second
      const row = listEl.querySelector(`[data-id="${id}"]`);
      if (row) $(".timer", row).textContent = fmt(t.remainingSec);
    }

    function startTimer(id){
      // pause all others for single-focus flow
      for (const t of tasks){ if (t.id!==id && t.status==='running') pauseTimer(t.id); }
      const t = tasks.find(x=>x.id===id); if (!t || t.status==='done') return;
      if (intervals.has(id)) return;
      t.status = 'running';
      const intervalId = setInterval(()=>tick(id), 1000);
      intervals.set(id, intervalId);
      persist();
    }
    function pauseTimer(id){
      const t = tasks.find(x=>x.id===id); if (!t) return;
      if (intervals.has(id)){ clearInterval(intervals.get(id)); intervals.delete(id); }
      if (t.status!=='done') t.status = 'paused';
      persist();
    }
    function stopTimer(id){
      if (intervals.has(id)){ clearInterval(intervals.get(id)); intervals.delete(id); }
    }
    function deleteTask(id){
      stopTimer(id);
      tasks = tasks.filter(t=>t.id!==id);
      persist();
    }
    function doneTask(id){
      const t = tasks.find(x=>x.id===id); if (!t) return;
      stopTimer(id);
      if (t.status!=='done'){ t.status='done'; stats.doneCount++; }
      persist();
    }

    // ------- Persistence & Render -------
    function persist(rerender=true){
      save(storeKey, tasks);
      save(statsKey, stats);
      if (rerender) render();
    }

    // ------- Notifications (optional) -------
    function notify(msg){
      if (!("Notification" in window)) return;
      if (Notification.permission === "granted"){
        new Notification("Task Timer", { body: msg });
      }
    }
    // Ask permission once
    if ("Notification" in window && Notification.permission === "default"){
      Notification.requestPermission().catch(()=>{});
    }

    // ------- Event Wiring -------
    $("#addForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      const title = $("#taskInput").value.trim();
      const mins = parseInt($("#durationSelect").value,10);
      if (!title) return;
      const id = crypto.randomUUID?.() ?? String(Date.now()+Math.random());
      const sec = mins*60;
      tasks.unshift({
        id, title,
        durationSec: sec,
        remainingSec: sec,
        status: 'new',
        createdAt: Date.now()
      });
      $("#taskInput").value = "";
      persist();
      // move focus to the new Start button for accessibility
      setTimeout(()=>{
        const row = listEl.querySelector(`[data-id="${id}"] [data-action="start"]`);
        row?.focus();
      }, 0);
    });

    $("#clearAll").addEventListener("click", ()=>{
      if (!confirm("Clear all tasks and stats?")) return;
      for (const id of intervals.keys()) stopTimer(id);
      tasks = [];
      stats = {focusedSec:0, doneCount:0};
      persist();
    });

    // Delegate task buttons
    listEl.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-action]"); if (!btn) return;
      const id = e.target.closest(".task")?.dataset.id;
      const action = btn.dataset.action;
      if (action==='start') startTimer(id);
      if (action==='pause') pauseTimer(id);
      if (action==='delete') deleteTask(id);
      if (action==='done') doneTask(id);
    });

    // Keyboard: Space toggles first selected/running task
    document.addEventListener("keydown", (e)=>{
      if (e.code === "Space" && !/input|select|textarea/i.test(document.activeElement.tagName)){
        e.preventDefault();
        // prefer running task, else first non-done task
        const running = tasks.find(t=>t.status==='running');
        if (running) { pauseTimer(running.id); return; }
        const next = tasks.find(t=>t.status!=='done');
        if (next) startTimer(next.id);
      }
    });

    // Initial paint
    render();
  </script>
</body>
</html>